{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1 class="my-4">–í—Å–µ –∏–≥—Ä–æ–∫–∏</h1>
    
    <div class="accordion" id="playersAccordion">
        {% for player in players %}
            {% if not player.is_current_player or is_admin %}
            <div class="accordion-item mb-3">
                <h2 class="accordion-header" id="heading{{ player.id }}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                            data-bs-target="#collapse{{ player.id }}" aria-expanded="false" 
                            aria-controls="collapse{{ player.id }}">
                        <strong>–ò–≥—Ä–æ–∫ ‚Ññ{{ player.id }}</strong> - {{ player.player_name }}
                    </button>
                </h2>
                <div id="collapse{{ player.id }}" class="accordion-collapse collapse" 
                    aria-labelledby="heading{{ player.id }}" data-bs-parent="#playersAccordion">
                    <div class="accordion-body">
                        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                        <div class="mb-3">
                            <p>ü™™ <strong>–ò–º—è: {{ player.name }}</strong> </p>

                            {% if player.profession_revealed or is_admin %}
                                <p>üíº <strong>–ü—Ä–æ—Ñ–µ—Å—Å–∏—è:</strong> 
                                    {{ player.profession }}
                                    {% if is_admin%}
                                        {% if player.profession_revealed %}
                                            <button class="btn btn-sm btn-outline-danger reveal-btn" data-field="profession" data-player="{{ player.id }}">–ó–∞–∫—Ä—ã—Ç—å</button>
                                        {% else %}
                                            <button class="btn btn-sm btn-outline-primary reveal-btn" data-field="profession" data-player="{{ player.id }}">–û—Ç–∫—Ä—ã—Ç—å</button>
                                        {% endif %}
                                    {% endif %}
                                </p>
                            {% endif %}

                            {% if player.gender_revealed or is_admin %}
                                <p>üë• <strong>–ü–æ–ª:</strong> 
                                    {{ player.gender }}
                                    {% if is_admin%}
                                        {% if player.gender_revealed %}
                                            <button class="btn btn-sm btn-outline-danger reveal-btn" data-field="gender" data-player="{{ player.id }}">–ó–∞–∫—Ä—ã—Ç—å</button>
                                        {% else %}
                                            <button class="btn btn-sm btn-outline-primary reveal-btn" data-field="gender" data-player="{{ player.id }}">–û—Ç–∫—Ä—ã—Ç—å</button>
                                        {% endif %}
                                    {% endif %}
                                </p>
                            {% endif %}

                            {% if player.age_revealed or is_admin %}
                                <p>üß∏ <strong>–í–æ–∑—Ä–∞—Å—Ç:</strong> 
                                    {{ player.age }}
                                    {% if is_admin%}
                                        {% if player.age_revealed %}
                                            <button class="btn btn-sm btn-outline-danger reveal-btn" data-field="age" data-player="{{ player.id }}">–ó–∞–∫—Ä—ã—Ç—å</button>
                                        {% else %}
                                            <button class="btn btn-sm btn-outline-primary reveal-btn" data-field="age" data-player="{{ player.id }}">–û—Ç–∫—Ä—ã—Ç—å</button>
                                        {% endif %}
                                    {% endif %}
                                </p>
                            {% endif %}

                            {% if player.childfree_revealed or is_admin %}
                                <p>üë∂ <strong>–î–µ—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ:</strong> 
                                    {{ player.childfree }}
                                    {% if is_admin%}
                                        {% if player.childfree_revealed %}
                                            <button class="btn btn-sm btn-outline-danger reveal-btn" data-field="childfree" data-player="{{ player.id }}">–ó–∞–∫—Ä—ã—Ç—å</button>
                                        {% else %}
                                            <button class="btn btn-sm btn-outline-primary reveal-btn" data-field="childfree" data-player="{{ player.id }}">–û—Ç–∫—Ä—ã—Ç—å</button>
                                        {% endif %}
                                    {% endif %}
                                </p>
                            {% endif %}

                            {% if player.physique_revealed or is_admin %}
                                <p>üßò <strong>–¢–µ–ª–æ—Å–ª–æ–∂–µ–Ω–∏–µ:</strong> 
                                    {{ player.physique }}
                                    {% if is_admin%}
                                        {% if player.physique_revealed %}
                                            <button class="btn btn-sm btn-outline-danger reveal-btn" data-field="physique" data-player="{{ player.id }}">–ó–∞–∫—Ä—ã—Ç—å</button>
                                        {% else %}
                                            <button class="btn btn-sm btn-outline-primary reveal-btn" data-field="physique" data-player="{{ player.id }}">–û—Ç–∫—Ä—ã—Ç—å</button>
                                        {% endif %}
                                    {% endif %}
                                </p>
                            {% endif %}
                        </div>

                        <!-- –ó–¥–æ—Ä–æ–≤—å–µ -->
                        <div class="mb-3">
                            {% set ns = namespace(show_health=true) %}
                            {% for item in player.health_items %}
                                {% if item.revealed or is_admin %}
                                    {% if ns.show_health %}
                                        <strong>–ó–¥–æ—Ä–æ–≤—å–µ:</strong>
                                        {% set ns.show_health = false %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            <ul class="list-unstyled">
                                {% for item in player.health_items %}
                                    {% if item.revealed or is_admin %}
                                    <li>
                                        ‚ù§ {{ item.value }}
                                        {% if is_admin%}
                                            {% if item.revealed %}
                                                <button class="btn btn-sm btn-outline-danger reveal-btn" data-field="health" data-index="{{ loop.index0 }}" data-player="{{ player.id }}">–ó–∞–∫—Ä—ã—Ç—å</button>
                                            {% else %}
                                                <button class="btn btn-sm btn-outline-primary reveal-btn" data-field="health" data-index="{{ loop.index0 }}" data-player="{{ player.id }}">–û—Ç–∫—Ä—ã—Ç—å</button>
                                            {% endif %}
                                        {% endif %}
                                    </li>
                                    {% endif %}
                                {% endfor %}
                            </ul>
                        </div>

                        <!-- –ß–µ—Ä—Ç—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ -->
                        <div class="mb-3">
                            {% set ns = namespace(show_traits=true) %}
                            {% for item in player.traits_items %}
                                {% if item.revealed or is_admin %}
                                    {% if ns.show_traits %}
                                        <strong>–ß–µ—Ä—Ç—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞:</strong>
                                        {% set ns.show_traits = false %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            <ul class="list-unstyled">
                                {% for item in player.traits_items %}
                                    {% if item.revealed or is_admin %}
                                    <li>
                                        üë∫ {{ item.value }}
                                        {% if is_admin%}
                                            {% if item.revealed %}
                                                <button class="btn btn-sm btn-outline-danger reveal-btn" data-field="traits" data-index="{{ loop.index0 }}" data-player="{{ player.id }}">–ó–∞–∫—Ä—ã—Ç—å</button>
                                            {% else %}
                                                <button class="btn btn-sm btn-outline-primary reveal-btn" data-field="traits" data-index="{{ loop.index0 }}" data-player="{{ player.id }}">–û—Ç–∫—Ä—ã—Ç—å</button>
                                            {% endif %}
                                        {% endif %}
                                    </li>
                                    {% endif %}
                                {% endfor %}
                            </ul>
                        </div>

                        <!-- –§–æ–±–∏–∏ -->
                        <div class="mb-3">
                            {% set ns = namespace(show_phobias=true) %}
                            {% for item in player.phobias_items %}
                                {% if item.revealed or is_admin %}
                                    {% if ns.show_phobias %}
                                        <strong>–§–æ–±–∏–∏:</strong>
                                        {% set ns.show_phobias = false %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            <ul class="list-unstyled">
                                {% for item in player.phobias_items %}
                                    {% if item.revealed or is_admin %}
                                    <li>
                                        üëª {{ item.value }}
                                        {% if is_admin%}
                                            {% if item.revealed %}
                                                <button class="btn btn-sm btn-outline-danger reveal-btn" data-field="phobias" data-index="{{ loop.index0 }}" data-player="{{ player.id }}">–ó–∞–∫—Ä—ã—Ç—å</button>
                                            {% else %}
                                                <button class="btn btn-sm btn-outline-primary reveal-btn" data-field="phobias" data-index="{{ loop.index0 }}" data-player="{{ player.id }}">–û—Ç–∫—Ä—ã—Ç—å</button>
                                            {% endif %}
                                        {% endif %}
                                    </li>
                                    {% endif %}
                                {% endfor %}
                            </ul>
                        </div>

                        <!-- –•–æ–±–±–∏ -->
                        <div class="mb-3">
                            {% set ns = namespace(show_hobbies=true) %}
                            {% for item in player.hobbies_items %}
                                {% if item.revealed or is_admin %}
                                    {% if ns.show_hobbies %}
                                        <strong>–•–æ–±–±–∏:</strong>
                                        {% set ns.show_hobbies = false %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            <ul class="list-unstyled">
                                {% for item in player.hobbies_items %}
                                    {% if item.revealed or is_admin %}
                                    <li>
                                        üé£ {{ item.value }}
                                        {% if is_admin%}
                                            {% if item.revealed %}
                                                <button class="btn btn-sm btn-outline-danger reveal-btn" data-field="hobbies" data-index="{{ loop.index0 }}" data-player="{{ player.id }}">–ó–∞–∫—Ä—ã—Ç—å</button>
                                            {% else %}
                                                <button class="btn btn-sm btn-outline-primary reveal-btn" data-field="hobbies" data-index="{{ loop.index0 }}" data-player="{{ player.id }}">–û—Ç–∫—Ä—ã—Ç—å</button>
                                            {% endif %}
                                        {% endif %}
                                    </li>
                                    {% endif %}
                                {% endfor %}
                            </ul>
                        </div>

                        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                        <div class="mb-3">
                            {% set ns = namespace(show_additional_info=true) %}
                            {% for item in player.additional_info_items %}
                                {% if item.revealed or is_admin %}
                                    {% if ns.show_additional_info %}
                                        <strong>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong>
                                        {% set ns.show_additional_info = false %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            <ul class="list-unstyled">
                                {% for item in player.additional_info_items %}
                                    {% if item.revealed or is_admin %}
                                    <li>
                                        üìù {{ item.value }}
                                        {% if is_admin%}
                                            {% if item.revealed %}
                                                <button class="btn btn-sm btn-outline-danger reveal-btn" data-field="additional_info" data-index="{{ loop.index0 }}" data-player="{{ player.id }}">–ó–∞–∫—Ä—ã—Ç—å</button>
                                            {% else %}
                                                <button class="btn btn-sm btn-outline-primary reveal-btn" data-field="additional_info" data-index="{{ loop.index0 }}" data-player="{{ player.id }}">–û—Ç–∫—Ä—ã—Ç—å</button>
                                            {% endif %}
                                        {% endif %}
                                    </li>
                                    {% endif %}
                                {% endfor %}
                            </ul>
                        </div>

                        <!-- –ë–∞–≥–∞–∂ -->
                        <div class="mb-3">
                            {% set ns = namespace(show_baggage=true) %}
                            {% for item in player.baggage_items %}
                                {% if item.revealed or is_admin %}
                                    {% if ns.show_baggage %}
                                        <strong>–ë–∞–≥–∞–∂:</strong>
                                        {% set ns.show_baggage = false %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            <ul class="list-unstyled">
                                {% for item in player.baggage_items %}
                                    {% if item.revealed or is_admin %}
                                    <li>
                                        üì¶ {{ item.value }}
                                        {% if is_admin%}
                                            {% if item.revealed %}
                                                <button class="btn btn-sm btn-outline-danger reveal-btn" data-field="baggage" data-index="{{ loop.index0 }}" data-player="{{ player.id }}">–ó–∞–∫—Ä—ã—Ç—å</button>
                                            {% else %}
                                                <button class="btn btn-sm btn-outline-primary reveal-btn" data-field="baggage" data-index="{{ loop.index0 }}" data-player="{{ player.id }}">–û—Ç–∫—Ä—ã—Ç—å</button>
                                            {% endif %}
                                        {% endif %}
                                    </li>
                                    {% endif %}
                                {% endfor %}
                            </ul>
                        </div>
                        
                        <!-- –ö–∞—Ä—Ç—ã –¥–µ–π—Å—Ç–≤–∏—è -->
                        <div class="mb-3">
                            {% set ns = namespace(show_cards=true) %}
                            {% for item in player.cards_items %}
                                {% if item.revealed or is_admin %}
                                    {% if ns.show_cards %}
                                        <strong>–ö–∞—Ä—Ç—ã –¥–µ–π—Å—Ç–≤–∏—è:</strong>
                                        {% set ns.show_cards = false %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            <ul class="list-unstyled">
                                {% for item in player.cards_items %}
                                    {% if item.revealed or is_admin %}
                                    <li>
                                        üÉè –ö–∞—Ä—Ç–∞ {{ loop.index }}: {{ item.value }}
                                        {% if is_admin%}
                                            {% if item.revealed %}
                                                <button class="btn btn-sm btn-outline-danger reveal-btn" data-field="cards" data-index="{{ loop.index0 }}" data-player="{{ player.id }}">–ó–∞–∫—Ä—ã—Ç—å</button>
                                            {% else %}
                                                <button class="btn btn-sm btn-outline-primary reveal-btn" data-field="cards" data-index="{{ loop.index0 }}" data-player="{{ player.id }}">–û—Ç–∫—Ä—ã—Ç—å</button>
                                            {% endif %}
                                        {% endif %}
                                    </li>
                                    {% endif %}
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ "–û—Ç–∫—Ä—ã—Ç—å/–ó–∞–∫—Ä—ã—Ç—å"
    document.querySelectorAll('.reveal-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const button = this;
            const playerId = button.dataset.player;
            const field = button.dataset.field;
            const index = button.dataset.index !== undefined ? button.dataset.index : null;
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
            button.disabled = true;
            
            try {
                const response = await fetch('/api/reveal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        player_id: playerId,
                        field: field,
                        index: index
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // –ù–∞—Ö–æ–¥–∏–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
                    const parentElement = button.closest('li') || button.closest('p');
                    
                    if (button.textContent.trim() === '–û—Ç–∫—Ä—ã—Ç—å') {
                        // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ "–ó–∞–∫—Ä—ã—Ç—å"
                        button.textContent = '–ó–∞–∫—Ä—ã—Ç—å';
                        button.classList.remove('btn-outline-primary');
                        button.classList.add('btn-outline-danger');
                        
                        // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ–ª–µ-–º–∞—Å—Å–∏–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç
                        if (index !== null) {
                            parentElement.style.display = 'block';
                        }
                    } else {
                        // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ "–û—Ç–∫—Ä—ã—Ç—å"
                        button.textContent = '–û—Ç–∫—Ä—ã—Ç—å';
                        button.classList.remove('btn-outline-danger');
                        button.classList.add('btn-outline-primary');
                        
                        // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ–ª–µ-–º–∞—Å—Å–∏–≤, —Å–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç
                        if (index !== null) {
                            parentElement.style.display = 'none';
                        }
                    }
                    
                    // –î–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –ø–æ–ª–µ–π –æ–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –≤—Å–µ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
                    if (index === null) {
                        const fieldElement = parentElement.querySelector('span.field-value');
                        if (fieldElement) {
                            fieldElement.style.display = button.textContent.trim() === '–ó–∞–∫—Ä—ã—Ç—å' ? 'inline' : 'none';
                        }
                    }
                }
            } catch (error) {
                console.error('Error:', error);
            } finally {
                button.disabled = false;
            }
        });
    });
});
</script>
{% endblock %}